<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Opsporing: Decor & Trechteren (Street View)</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root { --police-blue: #1d4e89; --gold: #ffd700; --bg: #f4f7f9; --success: #28a745; --danger: #e53e3e; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #2d3748; padding-bottom: 100px; }
        .container { max-width: 1200px; margin: auto; }
        
        .header { background: var(--police-blue); color: white; padding: 20px; text-align: center; border-bottom: 5px solid var(--gold); border-radius: 4px 4px 0 0; }
        
        .admin-panel { background: #fff; border: 2px dashed var(--police-blue); padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center; }
        .admin-panel input { padding: 10px; width: 300px; border: 1px solid #ccc; border-radius: 4px; }
        
        .workspace { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .map-container { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); height: 570px; }
        iframe { width: 100%; height: 480px; border: 0; border-radius: 4px; background: #eee; }

        .input-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        textarea { width: 100%; height: 250px; padding: 15px; border: 1px solid #cbd5e0; border-radius: 4px; font-family: inherit; box-sizing: border-box; resize: none; font-size: 1em; }
        
        .btn-send { background: var(--success); color: white; border: none; padding: 15px; width: 100%; font-weight: bold; cursor: pointer; text-transform: uppercase; margin-top: 10px; border-radius: 4px; }
        .btn-admin { background: var(--police-blue); color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; font-weight: bold; }

        /* LIVE FEED */
        .aangifte-kaart { 
            background: white; 
            margin-top: 30px; 
            padding: 0; 
            border-radius: 12px; 
            display: grid; 
            grid-template-columns: 1fr 400px; 
            gap: 0; 
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .tekst-sectie { padding: 25px; border-right: 1px solid #eee; }
        .tekst-sectie strong { font-size: 1.2em; color: var(--police-blue); display: block; margin-bottom: 15px; }
        .pv-tekst { 
            white-space: pre-wrap; 
            background: #f8fafc; 
            padding: 20px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 1.1em; 
            line-height: 1.6; 
            color: #1a202c; 
        }

        .feedback-sectie { background: #fffbeb; padding: 25px; border-left: 4px solid var(--gold); display: flex; flex-direction: column; }
        .feedback-sectie h4 { margin: 0 0 15px 0; color: #856404; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9em; }

        .vinklijst { list-style: none; padding: 0; margin-bottom: 20px; }
        .vinklijst li { padding: 8px 12px; margin-bottom: 5px; border-radius: 6px; display: flex; align-items: center; font-weight: 500; }
        .vinklijst li.checked { background: #fef3c7; color: #92400e; }
        .vinklijst li.unchecked { opacity: 0.4; color: #a1a1aa; }
        .vinklijst input { margin-right: 15px; transform: scale(1.4); cursor: pointer; }

        .feedback-display { 
            background: white; 
            border: 2px solid var(--gold); 
            padding: 15px; 
            border-radius: 8px; 
            min-height: 50px; 
            max-height: 200px;
            overflow-y: auto;
            font-weight: 600;
            color: #1d4e89;
            margin-bottom: 15px;
            white-space: pre-wrap;
        }
        
        .feedback-editor { 
            width: 100%; 
            height: 100px; 
            padding: 10px; 
            border: 1px dashed #b45309; 
            background: #fff;
            font-family: inherit;
            box-sizing: border-box;
            resize: vertical;
        }

        .btn-feedback-publiceer {
            background: var(--police-blue);
            color: white;
            border: none;
            padding: 10px;
            margin-top: 5px;
            cursor: pointer;
            border-radius: 4px;
            font-weight: bold;
        }

        /* END OF LES PANEL */
        .end-session-panel {
            margin-top: 80px;
            padding: 40px;
            background: #2d3748;
            color: white;
            border-radius: 12px;
            text-align: center;
        }

        .btn-download { background: var(--success); color: white; border: none; padding: 15px 30px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 10px; font-size: 1.1em; }
        .btn-reset-final { background: var(--danger); color: white; border: none; padding: 15px 30px; cursor: pointer; border-radius: 4px; font-weight: bold; margin: 10px; font-size: 1.1em; }

        @media (max-width: 900px) {
            .workspace, .aangifte-kaart { grid-template-columns: 1fr; }
            .feedback-sectie { border-left: none; border-top: 4px solid var(--gold); }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>Oefening: Decorbeschrijving & Trechteren</h1>
    </div>

    <div class="admin-panel">
        <strong>DOCENT:</strong> 
        <input type="text" id="locatie-input" placeholder="Adres (bijv. Dam 1, Amsterdam)">
        <button class="btn-admin" onclick="wijzigLocatie()">LOCATIE UPDATEN</button>
    </div>

    <div class="workspace">
        <div class="map-container">
            <h3 id="huidige-locatie-titel">Decor: Laden...</h3>
            <iframe id="map-iframe" src=""></iframe>
        </div>

        <div class="input-container">
            <input type="text" id="student-naam" placeholder="Naam Verbalisant" style="width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #cbd5e0; border-radius: 4px; font-weight: bold;">
            <div class="instruction-box" style="background: #eef2ff; border-left: 4px solid var(--police-blue); padding: 10px; font-size: 0.85em; margin-bottom: 10px;">
                <strong>METHODIEK:</strong> Verbalisant positie -> Links naar Rechts -> Groot naar Klein.
            </div>
            <textarea id="input-tekst" placeholder="Typ hier de volledige decorbeschrijving..."></textarea>
            <button class="btn-send" onclick="verstuurData()">Publiceer voor de klas</button>
        </div>
    </div>

    <h2 style="color: var(--police-blue); margin-top: 50px; text-align: center;">LIVE FEED ONDERWIJSMODUS</h2>
    <div id="live-feed">Wachten op inzendingen...</div>

    <div class="end-session-panel">
        <h3>Einde Les: Administratie & Opslag</h3>
        <p>Download eerst alle inzendingen als bewijslast of voor later gebruik, alvorens de feed te wissen.</p>
        <button class="btn-download" onclick="downloadResultaten()">üì• DOWNLOAD ALLES (.TXT)</button>
        <button class="btn-reset-final" onclick="wisAlles()">‚ö†Ô∏è FEED DEFINITIEF WISSEN</button>
    </div>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyB12mTMBnuxdC4W4htyFO_C7Dnh3maVKew",
        authDomain: "decoroefening.firebaseapp.com",
        databaseURL: "https://decoroefening-default-rtdb.europe-west1.firebasedatabase.app/",
        projectId: "decoroefening",
        appId: "1:945998495824:web:a76dc7519b3b262a021155"
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let lokaleDataCopy = {};

    // --- LOCATIE FUNCTIES ---
    function wijzigLocatie() {
        const nieuwAdres = document.getElementById('locatie-input').value;
        if(nieuwAdres) database.ref('decor_instellingen').update({ huidige_locatie: nieuwAdres });
    }

    database.ref('decor_instellingen/huidige_locatie').on('value', (snapshot) => {
        const locatie = snapshot.val() || "Utrecht Centraal";
        document.getElementById('huidige-locatie-titel').innerText = "üìç Locatie: " + locatie;
        document.getElementById('map-iframe').src = `https://maps.google.com/maps?q=${encodeURIComponent(locatie)}&t=&z=15&ie=UTF8&iwloc=&output=embed`;
    });

    // --- DATA VERZENDEN ---
    function verstuurData() {
        const naam = document.getElementById('student-naam').value;
        const tekst = document.getElementById('input-tekst').value;
        if(!naam || !tekst) return alert("Vul je naam en de beschrijving in.");
        
        database.ref('decor_oefeningen').push({
            naam: naam,
            tekst: tekst,
            timestamp: new Date().toLocaleString(),
            feedback: { c1:false, c2:false, c3:false, c4:false, c5:false, c6:false, opmerking: "" }
        });
        document.getElementById('input-tekst').value = '';
    }

    // --- FEEDBACK FUNCTIES ---
    function updateCheck(key, field, value) { 
        database.ref('decor_oefeningen/' + key + '/feedback').update({ [field]: value }); 
    }

    function publiceerFeedback(key) {
        const feedbackTekst = document.getElementById(`editor-${key}`).value;
        database.ref('decor_oefeningen/' + key + '/feedback').update({ opmerking: feedbackTekst });
        alert("Feedback gepubliceerd voor deze student.");
    }

    // --- AFSLUITING & DOWNLOAD ---
    function downloadResultaten() {
        if (!lokaleDataCopy || Object.keys(lokaleDataCopy).length === 0) return alert("Geen data om te downloaden.");
        
        let inhoud = "RESULTATEN OEFENING: DECORBESCHRIJVING\n";
        inhoud += "Gegenereerd op: " + new Date().toLocaleString() + "\n";
        inhoud += "--------------------------------------------------\n\n";

        Object.keys(lokaleDataCopy).forEach(key => {
            const item = lokaleDataCopy[key];
            inhoud += `VERBALISANT: ${item.naam}\n`;
            inhoud += `TIJDSTIP: ${item.timestamp || 'onbekend'}\n`;
            inhoud += `BESCHRIJVING:\n${item.tekst}\n\n`;
            inhoud += `FEEDBACK DOCENT:\n${item.feedback.opmerking || "Geen opmerkingen"}\n`;
            inhoud += `--------------------------------------------------\n\n`;
        });

        const blob = new Blob([inhoud], { type: 'text/plain' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `Decoroefening_Resultaten_${new Date().toLocaleDateString()}.txt`;
        link.click();
    }

    function wisAlles() { 
        if(confirm("LET OP: Dit verwijdert alle inzendingen definitief uit de database. Heb je de download al gemaakt?")) {
            database.ref('decor_oefeningen').remove();
            alert("Database is gereset.");
        }
    }

    // --- LIVE FEED RENDEREN ---
    database.ref('decor_oefeningen').on('value', (snapshot) => {
        const feed = document.getElementById('live-feed');
        feed.innerHTML = '';
        const data = snapshot.val();
        lokaleDataCopy = data; // Bewaar voor download
        
        if (data) {
            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                const fb = item.feedback || {};
                const kaart = document.createElement('div');
                kaart.className = 'aangifte-kaart';
                
                kaart.innerHTML = `
                    <div class="tekst-sectie">
                        <strong>Verbalisant: ${item.naam}</strong>
                        <div class="pv-tekst">${item.tekst}</div>
                        ${fb.opmerking ? `<div style="margin-top:20px; border-top: 2px solid var(--gold); padding-top:15px; background: #f0f4f8; padding: 15px; border-radius: 8px;">
                            <strong style="color:var(--police-blue);">FEEDBACK DOCENT:</strong>
                            <p style="white-space: pre-wrap; font-style: italic;">${fb.opmerking}</p>
                        </div>` : ''}
                    </div>
                    <div class="feedback-sectie">
                        <h4>Beoordeling & Feedback</h4>
                        <ul class="vinklijst">
                            <li class="${fb.c1?'checked':'unchecked'}"><input type="checkbox" ${fb.c1?'checked':''} onchange="updateCheck('${key}','c1',this.checked)"> Kaal decor (TT)</li>
                            <li class="${fb.c2?'checked':'unchecked'}"><input type="checkbox" ${fb.c2?'checked':''} onchange="updateCheck('${key}','c2',this.checked)"> Veranderlijk decor (VT)</li>
                            <li class="${fb.c3?'checked':'unchecked'}"><input type="checkbox" ${fb.c3?'checked':''} onchange="updateCheck('${key}','c3',this.checked)"> Positie verbalisant</li>
                            <li class="${fb.c4?'checked':'unchecked'}"><input type="checkbox" ${fb.c4?'checked':''} onchange="updateCheck('${key}','c4',this.checked)"> Van links naar rechts</li>
                            <li class="${fb.c5?'checked':'unchecked'}"><input type="checkbox" ${fb.c5?'checked':''} onchange="updateCheck('${key}','c5',this.checked)"> Van groot naar klein</li>
                            <li class="${fb.c6?'checked':'unchecked'}"><input type="checkbox" ${fb.c6?'checked':''} onchange="updateCheck('${key}','c6',this.checked)"> Element = Onderwerp</li>
                        </ul>
                        <div class="feedback-display">${fb.opmerking || "Wachtend op feedback..." }</div>
                        <textarea id="editor-${key}" class="feedback-editor" placeholder="Typ hier uitgebreide feedback...">${fb.opmerking || ""}</textarea>
                        <button class="btn-feedback-publiceer" onclick="publiceerFeedback('${key}')">PUBLICEER FEEDBACK</button>
                    </div>
                `;
                feed.appendChild(kaart);
            });
        } else {
            feed.innerHTML = '<p style="text-align:center; color:#666; padding: 20px;">Geen inzendingen gevonden.</p>';
        }
    });
</script>
</body>
</html>
